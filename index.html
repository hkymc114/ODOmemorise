<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ODO＆時刻OCR（ブラウザ完結・軽量版）</title>
<meta name="description" content="車メーターのODO(km)と時刻(hh:mm)のみをブラウザ内でOCR抽出し、端末内に保存・CSVエクスポートする最小構成Webアプリ。">
<style>
  :root{--pad:12px;--gap:12px;--fg:#111;--muted:#666;--brand:#0a7cff;--ok:#0c7;--bg:#fafafa}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif}
  header{padding:16px var(--pad);background:#fff;border-bottom:1px solid #e8e8e8;position:sticky;top:0;z-index:10}
  h1{font-size:18px;margin:0 0 6px}
  main{padding:var(--pad);display:grid;gap:var(--gap);max-width:980px;margin:auto}
  .panel{background:#fff;border:1px solid #e8e8e8;border-radius:8px;padding:var(--pad)}
  .row{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center}
  video,canvas,img{max-width:100%;border-radius:6px;border:1px solid #ddd;background:#000}
  input,button,select,textarea{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:6px}
  button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  button.ghost{background:#fff}
  .grid{display:grid;gap:var(--gap)}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left}
  th{background:#f7f7f7}
  .hint{font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Roboto Mono",monospace}
  .ok{color:var(--ok)}
</style>
</head>
<body>
<header>
  <h1>ODO＆時刻OCR（軽量・特化版）</h1>
  <div class="hint">カメラ撮影または画像選択 → OCR → <b>ODO(km)</b> と <b>時刻(hh:mm)</b>のみ抽出 → 端末内保存（localStorage）→ CSV出力。</div>
</header>

<main>
  <!-- 撮影／入力 -->
  <section class="panel grid cols-2">
    <div>
      <div class="row">
        <button id="btnStart" class="primary">カメラ起動</button>
        <button id="btnShot" disabled>撮影</button>
        <button id="btnStop" class="ghost" disabled>停止</button>
      </div>
      <div class="hint">※HTTPS必須。背面カメラが選ばれない場合は停止→再起動。</div>
      <video id="video" playsinline autoplay muted style="width:100%;aspect-ratio:16/9;"></video>
    </div>
    <div>
      <div class="row">
        <input id="fileInput" type="file" accept="image/*" capture="environment">
        <button id="btnOCR" class="primary" disabled>OCR実行</button>
      </div>
      <canvas id="canvas" width="1280" height="720" style="width:100%;aspect-ratio:16/9;"></canvas>
      <div class="row">
        <label><input type="checkbox" id="chkBinarize" checked> 2値化</label>
        <label>しきい値：<input id="threshold" type="range" min="80" max="200" value="140"></label>
        <span id="procMsg" class="hint"></span>
      </div>
    </div>
  </section>

  <!-- 結果／保存 -->
  <section class="panel grid cols-2">
    <div>
      <h3>OCRテキスト（編集可）</h3>
      <textarea id="rawText" rows="8" class="mono" placeholder="ここにOCR結果が入ります"></textarea>
      <div class="hint">※外部送信は行いません（ブラウザ内で完結）。</div>
    </div>
    <div>
      <h3>抽出フィールド（ODO & 時刻のみ）</h3>
      <div class="grid">
        <label>ODO (km)：<input id="fldOdo" inputmode="numeric" class="mono" placeholder="例：86589"></label>
        <label>時刻 (hh:mm)：<input id="fldClock" class="mono" placeholder="例：8:10"></label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnExtract">抽出</button>
        <button id="btnSave" class="primary">保存（localStorage）</button>
        <button id="btnClear" class="ghost">全消去</button>
      </div>
      <div id="extractMsg" class="hint"></div>
    </div>
  </section>

  <!-- ログ -->
  <section class="panel">
    <h3>ログ（端末内保存）</h3>
    <div class="row">
      <button id="btnExport">CSVエクスポート</button>
      <span class="hint">保存先キー：<span class="mono">odolog</span></span>
    </div>
    <table id="tbl">
      <thead><tr><th>#</th><th>保存日時</th><th>ODO(km)</th><th>時刻</th><th>OCRテキスト（抜粋）</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 参考（使用リソース） -->
  <section class="panel">
    <h3>使用API・ライブラリ（出典）</h3>
    <ul>
      <li>MediaDevices.getUserMedia（カメラ取得・HTTPS要件）— MDN Web Docs</li>
      <li>&lt;input capture="environment"&gt;（背面カメラ指示、実装差あり）— MDN</li>
      <li>Tesseract.js（ブラウザで動作するJS OCRライブラリ）— 公式リポジトリ</li>
    </ul>
  </section>
</main>

<!-- Tesseract.js（CDN）：ブラウザ内でOCR実行 -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js" crossorigin="anonymous"></script>

<script>
/* ===== 要素参照 ===== */
const $ = (s)=>document.querySelector(s);
const video = $("#video");
const canvas = $("#canvas");
const ctx = canvas.getContext("2d");
const rawText = $("#rawText");
const fldOdo = $("#fldOdo");
const fldClock = $("#fldClock");
const tblBody = $("#tbl tbody");
const state = { stream:null };

/* ===== カメラ制御 ===== */
async function startCamera(){
  try{
    const constraints = { video:{ facingMode:{ideal:"environment"}, width:{ideal:1280}, height:{ideal:720} }, audio:false };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    state.stream = stream;
    video.srcObject = stream;
    $("#btnShot").disabled = false;
    $("#btnStop").disabled = false;
  }catch(err){
    alert("カメラ起動に失敗しました。HTTPSと権限をご確認ください。\n"+err);
  }
}
function stopCamera(){
  if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); state.stream=null; }
  $("#btnShot").disabled = true;
  $("#btnStop").disabled = true;
}

/* ===== 撮影 → キャンバス描画 ===== */
async function drawFromVideo(){
  if(!video.videoWidth) return;
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  preprocess();
  $("#btnOCR").disabled = false;
}

/* ===== 画像ファイル入力 ===== */
$("#fileInput").addEventListener("change",(e)=>{
  const file = e.target.files[0]; if(!file) return;
  const img = new Image();
  img.onload = ()=>{
    canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    preprocess(); $("#btnOCR").disabled = false;
  };
  img.src = URL.createObjectURL(file);
});

/* ===== 前処理（グレースケール→任意2値化） ===== */
function preprocess(){
  const doBin = $("#chkBinarize").checked;
  const threshold = Number($("#threshold").value);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const d = img.data;
  for(let i=0;i<d.length;i+=4){
    const y = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
    if(doBin){ const v = y > threshold ? 255 : 0; d[i]=d[i+1]=d[i+2]=v; }
    else { d[i]=d[i+1]=d[i+2]=y; }
  }
  ctx.putImageData(img,0,0);
}

/* ===== OCR実行（英数字特化） ===== */
async function runOCR(){
  $("#procMsg").textContent = "OCR実行中…（初回は数秒かかります）";
  const blob = await new Promise(res=>canvas.toBlob(res,"image/png",1));
  const url = URL.createObjectURL(blob);
  try{
    const result = await Tesseract.recognize(url,'eng',{
      tessedit_char_whitelist:'0123456789: ODOkm/-',
      logger:m=>{ if(m.status) $("#procMsg").textContent = `${m.status} ${Math.round((m.progress||0)*100)}%`; }
    });
    rawText.value = (result.data && result.data.text ? result.data.text : "").trim();
    $("#procMsg").textContent = "OCR完了";
  }catch(err){
    $("#procMsg").textContent = "OCR失敗";
    alert("OCRエラー: "+err);
  }finally{
    URL.revokeObjectURL(url);
  }
}

/* ===== 正規表現で抽出（ODO & 時刻のみ） ===== */
function extractFields(){
  const t = rawText.value;

  // ODO: "ODO 86589 km" のような形式を想定
  const reOdo = /ODO\s*([0-9]{4,7})\s*km/i;
  let odo = (t.match(reOdo)||[])[1] || "";

  // 時刻: "8:10" 〜 "23:59"
  let clk = (t.match(/\b([01]?\d|2[0-3]):[0-5]\d\b/)||[])[0] || "";

  // 補助: コロンが飛んだケース "8 10" → 8:10 と推定（推論を含む）
  if(!clk){
    const m = t.match(/\b([01]?\d|2[0-3])\D([0-5]\d)\b/);
    if(m){ clk = `${m[1]}:${m[2]}`; } // 推論を含む
  }

  fldOdo.value = odo;
  fldClock.value = clk;
  $("#extractMsg").innerHTML = `抽出結果： ODO=<span class="mono">${odo||"-"}</span>, 時刻=<span class="mono">${clk||"-"}</span>`;
}

/* ===== 保存／一覧／削除／CSV ===== */
function loadLog(){
  const arr = JSON.parse(localStorage.getItem("odolog")||"[]");
  renderTable(arr);
}
function renderTable(arr){
  tblBody.innerHTML="";
  arr.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="mono">${r.timestamp}</td>
      <td class="mono">${r.odo}</td>
      <td class="mono">${r.clock}</td>
      <td class="mono">${(r.raw||"").slice(0,60).replace(/\n/g," ")}${(r.raw||"").length>60?"…":""}</td>
      <td><button class="del" data-i="${i}">削除</button></td>
    `;
    tblBody.appendChild(tr);
  });
}
function saveRow(){
  const arr = JSON.parse(localStorage.getItem("odolog")||"[]");
  const now = new Date();
  const row = {
    timestamp: now.toISOString().replace('T',' ').slice(0,19),
    odo: (fldOdo.value||"").trim(),
    clock: (fldClock.value||"").trim(),
    raw: (rawText.value||"").trim()
  };
  arr.push(row);
  localStorage.setItem("odolog", JSON.stringify(arr));
  renderTable(arr);
  alert("保存しました。");
}
function clearAll(){
  if(confirm("全データを削除します。よろしいですか？")){
    localStorage.removeItem("odolog");
    renderTable([]);
  }
}
tblBody.addEventListener("click",(e)=>{
  if(e.target.matches("button.del")){
    const i = Number(e.target.dataset.i);
    const arr = JSON.parse(localStorage.getItem("odolog")||"[]");
    arr.splice(i,1);
    localStorage.setItem("odolog", JSON.stringify(arr));
    renderTable(arr);
  }
});
function exportCSV(){
  const arr = JSON.parse(localStorage.getItem("odolog")||"[]");
  const header = ["timestamp","odo","clock","raw_text"];
  const lines = [header.join(",")];
  for(const r of arr){
    const esc = s=> `"${String(s??"").replace(/"/g,'""')}"`;
    lines.push([r.timestamp,r.odo,r.clock,esc(r.raw)].join(","));
  }
  const blob = new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `odolog_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== イベント登録 ===== */
$("#btnStart").addEventListener("click", startCamera);
$("#btnStop").addEventListener("click", stopCamera);
$("#btnShot").addEventListener("click", async()=>{ await drawFromVideo(); $("#btnOCR").disabled=false; });
$("#threshold").addEventListener("input", preprocess);
$("#chkBinarize").addEventListener("change", preprocess);
$("#btnOCR").addEventListener("click", runOCR);
$("#btnExtract").addEventListener("click", extractFields);
$("#btnSave").addEventListener("click", saveRow);
$("#btnClear").addEventListener("click", clearAll);
$("#btnExport").addEventListener("click", exportCSV);
window.addEventListener("load", loadLog);
</script>
</body>
</html>
